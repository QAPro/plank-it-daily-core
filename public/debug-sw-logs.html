<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîç Service Worker Debug Logs</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 800px; margin: 0 auto; }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #00d4ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .status-box {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-box.error {
      background: rgba(255, 68, 68, 0.1);
      border-color: #ff4444;
    }
    .status-box.success {
      background: rgba(0, 255, 136, 0.1);
      border-color: #00ff88;
    }
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }
    button {
      background: linear-gradient(135deg, #0066cc, #0099ff);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 153, 255, 0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 153, 255, 0.4);
    }
    button:active { transform: translateY(0); }
    button.secondary {
      background: linear-gradient(135deg, #444, #666);
      box-shadow: 0 4px 15px rgba(100, 100, 100, 0.3);
    }
    button.test {
      background: linear-gradient(135deg, #ff6b00, #ff9500);
      box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);
    }
    .log-container {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-entry {
      padding: 10px;
      margin: 6px 0;
      border-left: 3px solid #00d4ff;
      background: rgba(0, 212, 255, 0.05);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    .log-entry.error {
      border-left-color: #ff4444;
      background: rgba(255, 68, 68, 0.05);
      color: #ffaaaa;
    }
    .log-entry.success {
      border-left-color: #00ff88;
      background: rgba(0, 255, 136, 0.05);
      color: #aaffcc;
    }
    .log-entry .timestamp {
      color: #888;
      font-size: 11px;
      margin-right: 8px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }
    .info-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 14px;
    }
    .info-card .label {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .info-card .value {
      font-size: 16px;
      font-weight: 600;
      color: #00d4ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Service Worker Debug Logs</h1>
    
    <div id="swStatus" class="status-box">
      <span style="font-size: 24px;">‚è≥</span>
      <span>Checking service worker...</span>
    </div>

    <div class="btn-group">
      <button onclick="clearLogs()" class="secondary">Clear Logs</button>
      <button onclick="checkStatus()">Check SW Status</button>
      <button onclick="testSubscription()" class="test">Test Subscription</button>
      <button onclick="testNotification()" class="test">Test Notification</button>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <div class="label">Permission</div>
        <div class="value" id="permissionStatus">-</div>
      </div>
      <div class="info-card">
        <div class="label">Subscription</div>
        <div class="value" id="subscriptionStatus">-</div>
      </div>
      <div class="info-card">
        <div class="label">SW State</div>
        <div class="value" id="swState">-</div>
      </div>
      <div class="info-card">
        <div class="label">Endpoint</div>
        <div class="value" id="endpointInfo" style="font-size: 11px; word-break: break-all;">-</div>
      </div>
    </div>

    <div class="log-container" id="logContainer"></div>
  </div>

  <script>
    const logs = [];
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const logEntry = { timestamp, message, type };
      logs.push(logEntry);
      
      const logContainer = document.getElementById('logContainer');
      const logElement = document.createElement('div');
      logElement.className = `log-entry ${type}`;
      logElement.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
      logContainer.appendChild(logElement);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLogs() {
      logs.length = 0;
      document.getElementById('logContainer').innerHTML = '';
      addLog('Logs cleared');
    }

    async function checkStatus() {
      addLog('Checking service worker registration...');
      
      if (!('serviceWorker' in navigator)) {
        addLog('‚ùå Service Worker not supported', 'error');
        return;
      }

      try {
        const registration = await navigator.serviceWorker.ready;
        addLog('‚úÖ Service Worker registered', 'success');
        
        const state = registration.active?.state || 'unknown';
        addLog(`SW State: ${state}`);
        document.getElementById('swState').textContent = state;
        
        const scriptURL = registration.active?.scriptURL || 'unknown';
        addLog(`SW Script URL: ${scriptURL}`);
        
        // Check push subscription
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          addLog('‚úÖ Push subscription found!', 'success');
          document.getElementById('subscriptionStatus').textContent = 'Active';
          document.getElementById('endpointInfo').textContent = subscription.endpoint.substring(0, 50) + '...';
          
          const keys = subscription.toJSON().keys;
          addLog(`Keys: p256dh=${keys.p256dh ? 'present' : 'missing'}, auth=${keys.auth ? 'present' : 'missing'}`);
        } else {
          addLog('‚ùå No push subscription found', 'error');
          document.getElementById('subscriptionStatus').textContent = 'None';
          document.getElementById('endpointInfo').textContent = 'No subscription';
        }
        
        // Check permission
        const permission = Notification.permission;
        addLog(`Notification permission: ${permission}`);
        document.getElementById('permissionStatus').textContent = permission;
        
      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
        console.error('Status check error:', error);
      }
    }

    async function testSubscription() {
      addLog('üß™ Testing subscription flow...');
      
      try {
        // Step 1: Check permission
        addLog('Step 1: Checking notification permission...');
        let permission = Notification.permission;
        addLog(`Current permission: ${permission}`);
        
        if (permission === 'default') {
          addLog('Requesting permission...');
          permission = await Notification.requestPermission();
          addLog(`Permission result: ${permission}`);
        }
        
        if (permission !== 'granted') {
          addLog('‚ùå Permission not granted', 'error');
          return;
        }
        
        // Step 2: Get service worker
        addLog('Step 2: Getting service worker registration...');
        const registration = await navigator.serviceWorker.ready;
        addLog('‚úÖ Service worker ready', 'success');
        
        // Step 3: Check existing subscription
        addLog('Step 3: Checking existing subscription...');
        let subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          addLog('‚ö†Ô∏è Subscription already exists', 'error');
          addLog(`Endpoint: ${subscription.endpoint.substring(0, 60)}...`);
          return;
        }
        
        // Step 4: Fetch VAPID key
        addLog('Step 4: Fetching VAPID public key...');
        const response = await fetch('https://kgwmplptoctmoaefnpfg.supabase.co/functions/v1/get-vapid-public-key');
        
        if (!response.ok) {
          addLog(`‚ùå VAPID fetch failed: ${response.status} ${response.statusText}`, 'error');
          return;
        }
        
        const data = await response.json();
        const vapidKey = data.publicKey;
        
        if (!vapidKey) {
          addLog('‚ùå No VAPID key in response', 'error');
          return;
        }
        
        addLog(`‚úÖ VAPID key received (length: ${vapidKey.length})`, 'success');
        
        // Step 5: Convert VAPID key
        addLog('Step 5: Converting VAPID key...');
        function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
          const rawData = atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }
        
        const applicationServerKey = urlBase64ToUint8Array(vapidKey);
        addLog(`‚úÖ VAPID key converted (array length: ${applicationServerKey.length})`, 'success');
        
        // Step 6: Subscribe
        addLog('Step 6: Subscribing to push manager...');
        subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        });
        
        addLog('üéâ Subscription created successfully!', 'success');
        addLog(`Endpoint: ${subscription.endpoint.substring(0, 60)}...`);
        
        const keys = subscription.toJSON().keys;
        addLog(`Keys: p256dh=${keys.p256dh ? 'present' : 'missing'}, auth=${keys.auth ? 'present' : 'missing'}`);
        
        // Update status display
        document.getElementById('subscriptionStatus').textContent = 'Active';
        document.getElementById('endpointInfo').textContent = subscription.endpoint.substring(0, 50) + '...';
        
      } catch (error) {
        addLog(`‚ùå Subscription failed: ${error.message}`, 'error');
        console.error('Subscription error:', error);
      }
    }

    async function testNotification() {
      addLog('üîî Testing notification display...');
      
      try {
        const permission = Notification.permission;
        
        if (permission !== 'granted') {
          addLog('‚ùå Notification permission not granted', 'error');
          return;
        }
        
        const registration = await navigator.serviceWorker.ready;
        
        await registration.showNotification('Test Notification', {
          body: 'This is a test notification from the debug page',
          icon: '/icon-192.png',
          badge: '/icon-192.png',
          tag: 'test-notification',
          requireInteraction: false
        });
        
        addLog('‚úÖ Notification displayed', 'success');
        
      } catch (error) {
        addLog(`‚ùå Notification failed: ${error.message}`, 'error');
        console.error('Notification error:', error);
      }
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      addLog('Page loaded, initializing...');
      checkStatus();
    });

    // Update SW status indicator
    async function updateSwStatus() {
      const statusBox = document.getElementById('swStatus');
      
      if (!('serviceWorker' in navigator)) {
        statusBox.className = 'status-box error';
        statusBox.innerHTML = '<span style="font-size: 24px;">‚ùå</span><span>Service Worker not supported</span>';
        return;
      }
      
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          statusBox.className = 'status-box success';
          statusBox.innerHTML = '<span style="font-size: 24px;">‚úÖ</span><span>Service Worker is active with push subscription</span>';
        } else {
          statusBox.className = 'status-box error';
          statusBox.innerHTML = '<span style="font-size: 24px;">‚ö†Ô∏è</span><span>Service Worker active but no push subscription</span>';
        }
      } catch (error) {
        statusBox.className = 'status-box error';
        statusBox.innerHTML = '<span style="font-size: 24px;">‚ùå</span><span>Service Worker error</span>';
      }
    }

    updateSwStatus();
  </script>
</body>
</html>
